# Development Dockerfile with hot reload
FROM node:18-alpine

# Set working directory
WORKDIR /app

# Install nodemon globally for hot reload
RUN npm install -g nodemon ts-node

# Copy package files
COPY package*.json ./

# Install all dependencies (including dev dependencies)
RUN npm install

# Copy TypeScript config and source code
COPY tsconfig.json ./
COPY src/ ./src/
COPY index.ts ./
COPY init.sql ./
COPY .env.example ./

# Expose port
EXPOSE 3001

# Create non-root user for security
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodeuser -u 1001

# Change ownership of the app directory
RUN chown -R nodeuser:nodejs /app
USER nodeuser

# Create a startup script that ensures dependencies are installed
RUN echo '#!/bin/sh' > /app/start-dev.sh && \
    echo 'cd /app' >> /app/start-dev.sh && \
    echo 'if [ ! -d "node_modules" ] || [ package.json -nt node_modules/.package-lock.json ]; then' >> /app/start-dev.sh && \
    echo '  echo "Installing dependencies..."' >> /app/start-dev.sh && \
    echo '  npm install' >> /app/start-dev.sh && \
    echo 'fi' >> /app/start-dev.sh && \
    echo 'exec "$@"' >> /app/start-dev.sh && \
    chmod +x /app/start-dev.sh

# Start the application in development mode with hot reload
CMD ["/app/start-dev.sh", "npm", "run", "dev"]
